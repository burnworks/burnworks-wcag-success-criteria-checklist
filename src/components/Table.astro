---
import wcagData from "../assets/wcag_22.json";
import type { WCAGData, SuccessCriterion } from "../types/wcag";

const typedWcagData = wcagData as WCAGData;
const allCriteria: SuccessCriterion[] = [];

for (const principle of typedWcagData.wcag22.principles) {
    for (const guideline of principle.guidelines) {
        for (const criterion of guideline.success_criteria) {
            allCriteria.push(criterion);
        }
    }
}
---

<div>
    <table class="border-collapse w-240">
        <caption class="sr-only">達成基準チェックリストの概要</caption>
        <colgroup>
            <col class="w-50" />
            <col class="w-190" />
        </colgroup>
        <thead>
            <tr>
                <th scope="row" class="bg-gray-100 border border-gray-300 px-2 py-1 text-sm text-left"><label for="test-url">試験対象URL</label></th>
                <td class="border border-gray-300 px-2 py-1 text-sm"><input type="url" class="block w-full px-3 py-2 text-sm" id="test-url" /></td>
            </tr>
            <tr>
                <th scope="row" class="bg-gray-100 border border-gray-300 px-2 py-1 text-sm text-left"><label for="guideline-filter">対象とするガイドライン</label></th>
                <td class="border border-gray-300 px-2 py-1 text-sm">
                    <select id="guideline-filter" class="border border-gray-300 rounded px-3 py-2 text-sm" aria-label="対象とするガイドラインを選択">
                        <option value="2.2" selected>WCAG 2.2</option>
                        <option value="2.1">WCAG 2.1</option>
                        <option value="2.0">WCAG 2.0（JIS X 8341-3:2016）</option>
                    </select>
                </td>
            </tr>
            <tr>
                <th scope="row" class="bg-gray-100 border border-gray-300 px-2 py-1 text-sm text-left"><label for="level-filter">適合レベル</label></th>
                <td class="border border-gray-300 px-2 py-1 text-sm">
                    <select id="level-filter" class="border border-gray-300 rounded px-3 py-2 text-sm" aria-label="目標とする適合レベルを選択">
                        <option value="all" selected>すべて</option>
                        <option value="A">適合レベル A</option>
                        <option value="AA">適合レベル AA</option>
                        <option value="AAA">適合レベル AAA</option>
                    </select>
                </td>
            </tr>
            <tr>
                <th scope="row" class="bg-gray-100 border border-gray-300 px-2 py-1 text-sm text-left"><label for="test-tech">依存する技術</label></th>
                <td class="border border-gray-300 px-2 py-1 text-sm"><input type="text" class="block w-full px-3 py-2 text-sm" id="test-tech" /></td>
            </tr>
            <tr>
                <th scope="row" class="bg-gray-100 border border-gray-300 px-2 py-1 text-sm text-left"><label for="test-date">試験実施日</label></th>
                <td class="border border-gray-300 px-2 py-1 text-sm"><input type="text" class="block w-full px-3 py-2 text-sm" id="test-date" /></td>
            </tr>
        </thead>
    </table>
</div>

<div class="wcag-table-area mt-6 overflow-x-auto scroll-smooth w-full" role="region" tabindex="0">
    <table id="wcag-table" class="w-480 border-collapse">
        <caption class="sr-only">WCAG 達成基準チェックリスト</caption>
        <colgroup>
            <col class="w-20" />
            <col class="w-80" />
            <col class="w-140" />
            <col class="w-30" />
            <col class="w-30" />
            <col class="w-30" />
            <col class="w-130" />
            <col class="w-20" />
        </colgroup>
        <thead>
            <tr class="bg-gray-100">
                <th scope="col" class="border border-gray-300 px-2 py-1 text-sm">No.</th>
                <th scope="col" class="border border-gray-300 px-2 py-1 text-sm">達成基準</th>
                <th scope="col" class="border border-gray-300 px-2 py-1 text-sm">概要</th>
                <th scope="col" class="border border-gray-300 px-2 py-1 text-sm">適合レベル</th>
                <th scope="col" class="border border-gray-300 px-2 py-1 text-sm">適用</th>
                <th scope="col" class="border border-gray-300 px-2 py-1 text-sm">適合</th>
                <th scope="col" class="border border-gray-300 px-2 py-1 text-sm">備考</th>
                <th scope="col" class="border border-gray-300 px-2 py-1 text-sm">解説書</th>
            </tr>
        </thead>
        <tbody>
            {
                allCriteria.map((criterion) => (
                    <tr class={`${criterion.new_in_22 ? "bg-blue-50 border-blue-300 new-in-22" : criterion.new_in_21 ? "bg-green-50 border-green-300 new-in-21" : ""} level-${criterion.level}`}>
                        <td class="border border-gray-300 px-2 py-1 text-sm">{criterion.criterion}</td>
                        <td class="border border-gray-300 px-2 py-1 text-sm font-medium">{criterion.title}</td>
                        <td class="border border-gray-300 p-4 text-sm">
                            <div class="description-area" set:html={criterion.description} />
                        </td>
                        <td class="border border-gray-300 px-2 py-1 text-sm text-center">
                            <span
                                class={`px-2 py-1 rounded text-xs font-semibold ${
                                    criterion.level === "A" ? "bg-green-100 text-green-800" : criterion.level === "AA" ? "bg-yellow-100 text-yellow-800" : "bg-red-100 text-red-800"
                                }`}
                            >
                                {criterion.level}
                            </span>
                        </td>
                        <td class="border border-gray-300 px-2 py-1 text-sm">
                            <select class="inline-block w-full text-xs" aria-label={`「${criterion.title}」の「適用」「非適用」を選択`}>
                                <option value="" selected>
                                    未選択
                                </option>
                                <option value="applicable">適用</option>
                                <option value="not-applicable">非適用</option>
                            </select>
                        </td>
                        <td class="border border-gray-300 px-2 py-1 text-sm">
                            <select class="inline-block w-full text-xs" aria-label={`「${criterion.title}」の試験結果（「適合」または「不適合」）を選択`}>
                                <option value="" selected>
                                    未試験
                                </option>
                                <option value="pass">✅ 適合</option>
                                <option value="fail">❌ 不適合</option>
                            </select>
                        </td>
                        <td class="border border-gray-300 p-4 text-sm">
                            <textarea class="block w-full text-xs resize-y" rows="2" aria-label={`「${criterion.title}」の試験結果に対する「備考」を入力`} placeholder="備考を入力" />
                        </td>
                        <td class="border border-gray-300 px-2 py-1 text-sm text-center">
                            <a
                                href={criterion.understanding_url}
                                target="_blank"
                                aria-label={`「${criterion.title}」の解説（日本語訳）`}
                                title={`「${criterion.title}」の解説（日本語訳）`}
                                class="text-blue-700 hover:text-blue-900 underline text-xs inline-block px-4 py-2"
                            >
                                解説
                            </a>
                        </td>
                    </tr>
                ))
            }
        </tbody>
    </table>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const guidelineFilter = document.getElementById("guideline-filter") as HTMLSelectElement;
        const levelFilter = document.getElementById("level-filter") as HTMLSelectElement;
        const tableRows = document.querySelectorAll("#wcag-table tbody tr");

        function applyFilters() {
            const selectedGuideline = guidelineFilter.value;
            const selectedLevel = levelFilter.value;

            // 全ての行を一度表示状態にリセット
            tableRows.forEach((row) => {
                row.classList.remove("hidden-row");
            });

            // ガイドラインフィルター
            if (selectedGuideline === "2.0") {
                // WCAG 2.0を選択: 2.1と2.2で追加された項目を非表示
                document.querySelectorAll("#wcag-table .new-in-21, #wcag-table .new-in-22").forEach((row) => {
                    row.classList.add("hidden-row");
                });
            } else if (selectedGuideline === "2.1") {
                // WCAG 2.1を選択: 2.2で追加された項目を非表示
                document.querySelectorAll("#wcag-table .new-in-22").forEach((row) => {
                    row.classList.add("hidden-row");
                });
            }

            // 適合レベルフィルター
            if (selectedLevel === "A") {
                // レベルAを選択: AA、AAAを非表示
                document.querySelectorAll("#wcag-table .level-AA:not(.hidden-row), #wcag-table .level-AAA:not(.hidden-row)").forEach((row) => {
                    row.classList.add("hidden-row");
                });
            } else if (selectedLevel === "AA") {
                // レベルAAを選択: AAAを非表示
                document.querySelectorAll("#wcag-table .level-AAA:not(.hidden-row)").forEach((row) => {
                    row.classList.add("hidden-row");
                });
            }
        }

        // イベントリスナーを追加
        guidelineFilter.addEventListener("change", applyFilters);
        levelFilter.addEventListener("change", applyFilters);

        // 初期フィルターを適用
        applyFilters();
    });
</script>
